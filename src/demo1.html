<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="math.min.js"></script>
    <script>
        function norm_vec(v1, v2){
            var mat = math.cross(v1, v2);
            var den = math.norm(mat) + 1e-6;
            return math.divide(mat, den); 
        }

        function get_orth_joints(data, std=[0,5,17]){
            var num_joints = math.size(data)[0];
            var [p1, p2, p3] = [data[std[0]], data[std[1]], data[std[2]]];
            var T = [[1,0,0,-p1[0]], [0,1,0,-p1[1]], [0,0,1,-p1[2]], [0,0,0,1]];
            
            var sub31 = math.subtract(p3, p1);
            var vy = math.divide(sub31, math.norm(sub31) + 1e-6);
            var _vx = math.subtract(p2, p1);
            var vz = norm_vec(_vx, vy);
            var vx = norm_vec(vy, vz);

            var u_z = vz;
            var u_y = norm_vec(vz, [1,0,0]);
            var u_x = math.cross(u_y, u_z);
            var R1 = [math.concat(u_x, [0]), math.concat(u_y, [0]), math.concat(u_z, [0]), [0,0,0,1]];

            vx = math.multiply(R1, math.concat(vx, [1]));
            // console.log(vx)
            var cos = vx[0];
            var sin = math.cross(math.resize(vx, [3]), [1,0,0])[2]>0 ? -vx[1] : vx[1];
            var R2 = [[cos,-sin,0,0], [sin,cos,0,0], [0,0,1,0], [0,0,0,1]];
            var tran = math.multiply(math.multiply(R2, R1), T);

            var forth_col = math.ones(num_joints, 1);
            var joints = math.transpose(math.concat(data, forth_col, 1));
            var orth_joints = math.transpose(math.multiply(tran, joints));

            return orth_joints;
        }

        function download(filename, content, contentType) {
            if (!contentType) contentType = 'application/octet-stream';
            var a = document.createElement('a');
            var blob = new Blob([content]);
            a.href = window.URL.createObjectURL(blob);
            a.download = filename;
            a.click();
        }
    </script>
</head>

<body>
    <form>
        <label>
          名字:
          <input type="text" name="name" />
        </label>
        <input type="submit" value="提交" />
      </form>
    <div class="container">
        <video class="input_video" style="transform: scaleX(-1);"></video>
        <canvas class="output_canvas" style="transform: scaleX(-1);" width="1280px" height="720px"></canvas>
    </div>
    <div class="res" style="font-size: 5em; font-weight: bolder; color: red; position: absolute; top: 10px; right:10px;"></div>
    <button class="download">download</button>
    <script type="module">
        const videoElement = document.getElementsByClassName('input_video')[0];
        const canvasElement = document.getElementsByClassName('output_canvas')[0];
        const canvasCtx = canvasElement.getContext('2d');
        const btn = document.querySelector('.download');
        const res = document.querySelector('.res');
        const proj = [[0.0, 0.0, 0.0, 0.04220670219291683, 0.03149851598817132, -0.026492218828796085, 0.07837493290561962, 0.08929581766876572, -0.03629986014482872, 0.09192953722292622, 0.13776031125710272, -0.0431553408096056, 0.10038550600447814, 0.16867597150772082, -0.04717252426582076, 0.08559430474221973, 0.18006795907869114, 5.863477004888879e-18, 0.10781135797224967, 0.23654131209759094, -0.010386928201592751, 0.11378555806600682, 0.24374680778311675, -0.02254657508565081, 0.1190632784313357, 0.2517021255262365, -0.02755298705614669, 0.05756236413815381, 0.19070721795257384, 0.006126946654891795, 0.06638201044916442, 0.2584572362812108, -8.438116846367995e-05, 0.06813662918642503, 0.26599379249497723, -0.01218688255667657, 0.07348145686716379, 0.28000208334900906, -0.014856369572898846, 0.026774367417593474, 0.18361601944180667, 0.0054274083506337025, 0.029605118063364317, 0.24420275342962378, -0.0020696667861368583, 0.028361721817205518, 0.2379437471065681, -0.013799300259397828, 0.03071952847644311, 0.24067455028256, -0.014615165370019194, -0.004148498613519025, 0.1652555452255278, -1.3856109311760323e-17, -0.005875330439403017, 0.21085206059338132, -0.0030630463986907577, -0.006643732678491097, 0.2163622064093101, -0.011671531810550828, -0.005156136268706717, 0.22644005766886272, -0.012951851375587454], [0.0, 0.0, 0.0, -0.10130557154588601, 0.011767563094168166, -0.05764550864292526, -0.21315255909443948, -0.0049849511230822775, -0.08974785971311793, -0.3674122253748654, -0.019310911191801033, -0.09166554340907242, -0.4960120334753382, -0.020250077069311943, -0.08015778791301106, -0.061583642309360184, -0.038035006661841717, 1.7286326858823e-17, 0.01653385345911914, 0.0328034308260818, -0.06632618369526268, 0.05704896993194579, 0.23814620921647142, -0.062056513000360705, 0.07284433691985767, 0.3924836678700814, -0.05881436737830061, -0.011684399659347403, -0.03604156944490399, 0.016293442340174182, -0.001273854221973561, 0.004765575528670376, -0.07122439751825284, -0.022248306438200693, 0.11191974281522023, -0.09293351398429255, -0.027467928362902946, 0.1708479871862871, -0.09302919938789779, 0.034130877951827544, -0.05179167655052661, 0.014857139507468599, 0.009212209358542578, -0.03366911479725843, -0.09727208233109977, -0.015880090737289902, -0.015462930664717302, -0.1407363542305962, -0.01903623625245328, -0.024926493511976126, -0.14636223225734843, 0.07409291859623364, -0.08082336626272205, 1.3677499569886148e-16, 0.047544449633794984, -0.10013780363845798, -0.11096300406473052, 0.03566108027307766, -0.16792480120042816, -0.15151032588475802, 0.04680019156420417, -0.24122353838306473, -0.15678666224879276], [0.0, 0.0, 0.0, -0.068378602991882, -0.05483841512451853, 0.0018815703904803847, -0.10370852436687061, -0.14702033824281077, -0.02014460415755821, -0.08643280841125571, -0.22133084297356578, -0.05202448778969347, -0.0903039438495628, -0.26795265156535897, -0.07215026239758011, -0.12222755547569836, -0.15672468088624628, -6.479102082801067e-18, -0.08998402701207574, -0.22451262646143785, -0.07339993742754201, -0.08618584020235161, -0.2053950372352987, -0.09999655244283116, -0.1088280767899083, -0.22997819723355067, -0.11852510235138952, -0.05140994745097978, -0.10655151804662191, -0.0016191721942564526, 0.013872793165635616, -0.05917419913403697, 0.0030012735404465565, 0.05506166508627792, 0.21976591321906086, 0.0342717524323661, 0.05635280717530826, 0.400966378851983, 0.026228742763967815, 0.008767355588307366, -0.07725380835951433, -0.0003854527261561373, 0.041534137301501954, -0.009740167093856916, 0.012197835810202727, 0.054465002557717745, 0.2604938540384473, 0.045528596224192995, 0.04975553651910877, 0.42648820358617046, 0.04673844523059626, 0.05364864101142705, -0.07476191941765167, 9.470444579325035e-17, 0.04436140665025423, -0.03811466286860895, -0.007469606844023363, 0.03932314026432534, 0.10827747271487945, 0.034417977521601806, 0.03167790741898419, 0.2018427558391426, 0.054556998533222274], [0.0, 0.0, 0.0, -0.03805193184435091, 0.002871652673608538, -0.053842059869568436, -0.07474368900044216, -0.0004954107901353233, -0.06827933795479572, -0.10453703907202548, 0.024254631602684644, -0.044659096668970256, -0.14853335075295354, 0.018485490764934626, 0.02841185071055983, -0.025120606498529915, -8.276369283478403e-06, -1.1468017127598714e-17, -0.02838978552931834, 0.06072291071390773, -0.17770583536475656, -0.11569197342164686, -0.08383718710494327, -0.19145398600856506, -0.19117296486751256, -0.20670342827524135, -0.15621164583176433, 0.01801713115345987, 0.02889034180228339, 0.009395994086391048, 0.020837606256178587, 0.05121929713681109, -0.23783774833355903, -0.07080387047527492, -0.1535658084739173, -0.2774043064367802, -0.12040897540569122, -0.30187087399626067, -0.22985258453205398, 0.06719872095535942, 0.07472332303885731, 0.007957972897211875, 0.06638510279924593, 0.12842982391075308, -0.19841247594396583, 0.011408610246824219, -0.011553834875903198, -0.18740287793047983, -0.01347458294611299, -0.11008117714026626, -0.11501650097887907, 0.11213803951288036, 0.11922167420684845, 1.8577683742345122e-16, 0.10793513663704234, 0.2046528971759367, -0.0848795553536238, 0.08953517212732921, 0.26370865249929676, -0.06181025864464112, 0.09125329868984908, 0.3430684562582451, -0.008840671459160138], [0.0, 0.0, 0.0, 0.012439826879687208, 0.08904106708371233, -0.029925009929802605, -0.02131555270703388, 0.15729495531033164, -0.05550388613188239, -0.12172609596411799, 0.246633156439058, -0.0529335507355447, -0.2640129028616456, 0.36880878264943373, -0.01507050902388241, 0.049847916554713066, 0.05726554374754981, -4.257550964624561e-17, 0.03965518463802543, -0.01704088647244798, -0.01274880937463483, -0.01765237665078799, -0.29460141764926084, -0.05174456092300157, -0.06009922807735767, -0.5116250761012637, -0.06482783377815518, 0.04629986628223151, 0.08941409123174811, 0.018255200123093507, 0.08996281173029005, 0.17196331555792913, 0.021478982245663795, 0.1077483502718479, 0.1525211038228626, 0.04853816271947119, 0.12379498164868792, 0.17381662304295958, 0.10917985586189577, 0.014894502011182273, 0.08871525014345777, 0.01646878538627061, 0.022677966785938013, 0.1360658977371399, 0.01488795727271384, -0.008318434723239993, -0.0172785091353294, 0.01084070797122072, -0.03817048161741121, -0.10502195735907166, 0.05151664290049064, -0.0229195993559727, 0.06968131089224469, -3.760342122625115e-17, -0.0011534531188446952, 0.03723340776890248, -0.006306035470402822, -0.02720530841591446, -0.1590917673875376, -0.022486939189682073, -0.06764519684969415, -0.2945149344832173, -0.0014497209242542155], [0.0, 0.0, 0.0, 0.05537697610912089, -0.017492027475518365, 0.014294152958010285, 0.07749463743712737, -0.016550227580440245, 0.09076361291190224, 0.0812040264132289, -0.03216627727532346, 0.16778100267308368, 0.13485446766640882, -0.13669798277188652, 0.21486745462665707, -0.011474364189732102, -0.06148204834250101, -1.5580568770251225e-17, -0.012443882508754176, -0.06820317026648422, -0.036594125188755225, 0.02365150823161822, -0.06506754015012677, -0.008425915328673334, 0.09173643401402112, -0.02540297951459275, 0.02256339894571307, -0.02399292193041573, -0.03936911680342136, -0.013584836593652058, 0.07510561258337264, -0.03827281679565357, 0.009728242953858934, 0.14458461060112013, 0.2198063758728086, 0.11863428418080266, 0.12393778996187291, 0.34776035219672924, 0.14874680785206812, -0.007973902261414683, -0.04608044527845895, -0.024308158588504377, 0.03563241037607482, -0.022999746432682103, -0.1262738617461317, -0.003737062036356224, -0.1931010899193242, -0.21834422954301158, -0.08651336719726399, -0.4939774498551683, -0.2937145818333829, 0.019861081177108095, -0.05324495024630697, 2.694956963793803e-16, 0.06378474151786073, 0.062337331115226415, -0.10589289446371025, 0.07694996593234942, 0.17366629420299637, -0.15167105695455002, 0.05771115440487472, 0.1330115815680256, -0.2039552066849542], [0.0, 0.0, 0.0, -0.007416401668305334, -0.042566334707626045, 0.028253119751973397, 0.01572556430393136, 0.026481224638280502, 0.07842723656847991, 0.04411628715203947, 0.24424008179985143, 0.19573100744165284, 0.07663648154997679, 0.23798136250649723, 0.31116532370296723, -0.043772946284974835, -0.18324276708027776, 1.2976094075874307e-17, -0.027458974120947763, -0.09438376099873133, 0.09496392053927795, -0.1231698886988589, -0.06821590159237707, 0.220622053269268, -0.15174210799602086, 0.1273547656618855, 0.3007845340405747, -0.01820039765291612, -0.14468121585064853, -0.011149506281620914, 0.10205660360850456, -0.02038855411773235, -0.07398966180113702, -0.00041287994949593376, -0.05350708690164628, -0.04720017609362067, -0.07970288977695975, 0.004197355705941211, 0.019247580791936985, 0.044089169431270205, -0.06298778015774505, -0.009431087852692204, 0.20258410138255725, 0.062160701186932926, -0.121528654454942, 0.18011927678772197, 0.10786870700815353, -0.06326130273194584, 0.1400155091209872, 0.2747353650848413, 0.023557385926637513, 0.0863428929350827, 0.05135270681279774, 3.622937040896156e-16, 0.2475459039481365, 0.023227824291936167, -0.12126400920895565, 0.23322121077132213, -0.11026856003468712, -0.12225707107654643, 0.18420125346135224, -0.10082814890067444, -0.0864600876662687]];
        var std = [
            [1.09839294 , 0.22016239 ,-0.03715603], //剪刀
            [0.78745657 ,-0.01625664 ,-0.13014097], //拳头
            [1.50652159 ,-0.01676744 , 0.15385752], //布
            [-0.50537664,  0.32142944,  0.22329397], //good
            [0.76529495 ,-0.21252182 ,-0.08122976], // 666
            [0.967873   , 0.22418883 ,-0.24945341], // 1
            [1.13237362 ,-0.08448131 , 0.28961652], //ok
        ];
        var table = ['剪刀', '拳头', '布', 'good', '666', '1', 'ok'];
        var index = 0;
        var data;

        btn.addEventListener('click', function(){
            var orth_data = get_orth_joints(data);
            download(`${index}.json`, JSON.stringify(orth_data));
            index++;
        })
        
        function onResults(results) {
          canvasCtx.save();
          canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
          canvasCtx.drawImage(
              results.image, 0, 0, canvasElement.width, canvasElement.height);
              
          if (results.multiHandLandmarks) {
            var landmarks = results.multiHandLandmarks;
            if(landmarks.length === 0) {
                res.innerHTML = '无';
                return;
            }
            var points = landmarks[0]; // list(21), {x:,y:,z:}
            data = points.map(obj => {
                var tmp = [];
                tmp.push(obj.x);
                tmp.push(obj.y);
                tmp.push(obj.z);
                return tmp;
            });
            var orth_data = get_orth_joints(data).resize([21,3]);
            console.log(orth_data._data[8]);
            var proj_orth_data = math.multiply(math.flatten(orth_data), math.transpose(proj));
            proj_orth_data = math.resize(proj_orth_data, [3]);
            var ind = 0, max = 0 ,res_list = [];
            for(let i=0; i < std.length; i++){
                let tmp1 = math.sum(math.dotMultiply(proj_orth_data, std[i]));
                let tmp2 = math.divide(tmp1, math.norm(std[i]));
                let cos = math.divide(tmp2, math.norm(proj_orth_data));
                res_list.push(cos);
                if(cos > max){
                    ind = i;
                    max = cos;
                }
            }
            res.innerHTML = table[ind];
            // console.log(table[ind], res_list, ind);

            // if(results.multiHandedness.length > 0 && results.multiHandedness[0].label === 'Right'){
            //     console.log('right');
            // }

            for (const landmarks of results.multiHandLandmarks) {
            drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS,
                            {color: '#00FF00', lineWidth: 5});
            drawLandmarks(canvasCtx, landmarks, {color: '#FF0000', lineWidth: 2});
            }
          }
          canvasCtx.restore();
        }
        
        const hands = new Hands({locateFile: (file) => {
          return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }});
        hands.setOptions({
          maxNumHands: 2,
          minDetectionConfidence: 0.6,
          minTrackingConfidence: 0.5
        });
        hands.onResults(onResults);
        
        const camera = new Camera(videoElement, {
          onFrame: async () => {
            await hands.send({image: videoElement});
          },
          width: 1280,
          height: 720
        });
        camera.start();
    </script>
</body>
</html>